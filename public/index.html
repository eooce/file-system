<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Files Server</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div class="container">
        <h1>Files Server</h1>
        <div class="card-upload">
            <form class="upload-form" onsubmit="event.preventDefault(); uploadFile();">
                <span style="font-weight:bold; font-size:1.2rem;color:green;">Upload File</span>
                <input type="file" id="fileInput">
                <button type="submit">Upload</button>
            </form>
            <div id="uploadStatus"></div>
        </div>
        <div class="file-list-header">
            <span class="file-list-title">File List</span>
            <button class="refresh-btn" onclick="fetchFiles()">Refresh File List</button>
        </div>
        <div class="table-wrapper">
            <table id="fileTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Size</th>
                        <th>Last Modified</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <script>
        let currentXhr = null; // 全局变量保存当前xhr
        // 获取文件列表
        async function fetchFiles() {
            try {
                const response = await fetch('/api/files');
                const files = await response.json();
                const tableBody = document.querySelector('#fileTable tbody');
                tableBody.innerHTML = '';
                if (files.length === 0) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.colSpan = 4;
                    cell.textContent = 'No files found';
                    cell.style.textAlign = 'center';
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                    return;
                }
                files.forEach(file => {
                    const row = document.createElement('tr');
                    const nameCell = document.createElement('td');
                    const link = document.createElement('a');
                    link.href = file.downloadUrl;
                    link.textContent = file.name;
                    link.className = 'file-link';
                    link.target = '_blank';
                    link.onclick = function(e) {
                        const ext = file.name.split('.').pop().toLowerCase();
                        const imageExts = ['jpg','jpeg','png','gif','bmp','webp','svg'];
                        const videoExts = ['mp4','webm','ogg','mov','m4v','avi'];
                        const audioExts = ['mp3','wav','ogg','aac','flac','m4a'];
                        if (imageExts.includes(ext)) {
                            e.preventDefault();
                            const win = window.open();
                            win.document.write('<img src="' + file.downloadUrl + '" style="max-width:100vw;max-height:100vh;display:block;margin:auto;" />');
                        } else if (videoExts.includes(ext)) {
                            e.preventDefault();
                            const win = window.open();
                            win.document.write('<video src="' + file.downloadUrl + '" style="max-width:100vw;max-height:100vh;display:block;margin:auto;" controls autoplay></video>');
                        } else if (audioExts.includes(ext)) {
                            e.preventDefault();
                            const win = window.open();
                            win.document.write('<audio src="' + file.downloadUrl + '" style="width:100%;margin-top:2rem;" controls autoplay></audio>');
                        }
                    };
                    nameCell.appendChild(link);
                    const sizeCell = document.createElement('td');
                    sizeCell.textContent = file.size;
                    const dateCell = document.createElement('td');
                    dateCell.textContent = new Date(file.lastModified).toLocaleString();
                    const actionCell = document.createElement('td');
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.onclick = () => deleteFile(file.name);
                    actionCell.appendChild(deleteBtn);
                    row.appendChild(nameCell);
                    row.appendChild(sizeCell);
                    row.appendChild(dateCell);
                    row.appendChild(actionCell);
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error fetching files:', error);
                alert('Error loading file list');
            }
        }
        // 上传文件
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) {
                alert('Please select a file');
                return;
            }
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('filename', utf8ToBase64(file.name));
            // 显示进度条
            const progressContainer = document.createElement('div');
            progressContainer.className = 'progress-container';
            progressContainer.innerHTML = '<div class="progress-bar" id="progressBar">0%</div>';
            // 创建取消按钮
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '取消';
            cancelBtn.className = 'cancel-btn';
            cancelBtn.style.marginLeft = '10px';
            cancelBtn.onclick = function() {
                if (currentXhr) currentXhr.abort();
                progressContainer.remove();
                statusDiv.textContent = '已取消上传';
                statusDiv.style.color = '#e53935';
            };
            progressContainer.appendChild(cancelBtn);
            document.querySelector('.card-upload').insertAdjacentElement('afterend', progressContainer);
            const progressBar = document.getElementById('progressBar');
            const statusDiv = document.getElementById('uploadStatus');
            try {
                const xhr = new XMLHttpRequest();
                currentXhr = xhr;
                xhr.upload.addEventListener('progress', (event) => {
                    if (event.lengthComputable) {
                        const percentComplete = Math.round((event.loaded / event.total) * 100);
                        progressBar.style.width = percentComplete + '%';
                        progressBar.textContent = percentComplete + '%';
                    }
                });
                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        const result = JSON.parse(xhr.responseText);
                        statusDiv.textContent = 'Upload completed successfully!';
                        statusDiv.style.color = '#43a047';
                        fileInput.value = '';
                        setTimeout(() => {
                            fetchFiles();
                            setTimeout(() => {
                                progressContainer.remove();
                                statusDiv.textContent = '';
                            }, 2000);
                        }, 500);
                    } else {
                        const result = JSON.parse(xhr.responseText);
                        statusDiv.textContent = 'Error: ' + (result.error || 'Upload failed');
                        statusDiv.style.color = '#e53935';
                    }
                });
                xhr.addEventListener('error', () => {
                    statusDiv.textContent = 'Upload failed';
                    statusDiv.style.color = '#e53935';
                });
                xhr.addEventListener('abort', () => {
                    statusDiv.textContent = '已取消上传';
                    statusDiv.style.color = '#e53935';
                    progressContainer.remove();
                });
                xhr.open('POST', '/api/upload');
                xhr.send(formData);
                statusDiv.textContent = 'Uploading...';
                statusDiv.style.color = '#1976d2';
            } catch (error) {
                console.error('Upload error:', error);
                statusDiv.textContent = 'Upload failed';
                statusDiv.style.color = '#e53935';
                progressContainer.remove();
            }
        }
        // 删除文件
        async function deleteFile(filename) {
            if (!confirm('Are you sure you want to delete "' + filename + '"?')) {
                return;
            }
            try {
                const response = await fetch('/api/files/' + encodeURIComponent(filename), {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const result = await response.json();
                if (response.ok) {
                    alert('File deleted successfully');
                    fetchFiles();
                } else {
                    alert('Error: ' + (result.error || 'Delete failed'));
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Delete failed');
            }
        }
        // 初始加载文件列表
        fetchFiles();
        function utf8ToBase64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }
    </script>
</body>
</html>
